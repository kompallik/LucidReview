# docker-compose.prod.yml
# Production deployment for LucidReview
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Required environment variables (set in .env or CI secrets):
#   MYSQL_ROOT_PASSWORD, JWT_SECRET, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,
#   AWS_REGION, BEDROCK_MODEL_ID, CORS_ORIGINS, REDIS_URL

version: '3.8'

services:
  backend:
    restart: always
    environment:
      NODE_ENV: production
      LOG_LEVEL: warn
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGINS: ${CORS_ORIGINS}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      BEDROCK_MODEL_ID: ${BEDROCK_MODEL_ID:-us.anthropic.claude-sonnet-4-6}
      REDIS_URL: redis://redis:6379
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: lucidreview
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      DB_NAME: lucidreview
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  reviewer-ui:
    restart: always
    environment:
      NODE_ENV: production

  mysql:
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql_prod_data:/var/lib/mysql
    # Remove port exposure in production (backend connects internally)
    ports: !reset []

  redis:
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD:-} --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_prod_data:/data
    ports: !reset []

  hapi-fhir:
    restart: always

volumes:
  mysql_prod_data:
  redis_prod_data:
